<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Figa</title>
        <meta name="description" content="File Gallant">

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="./css/index.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <nav id="navbar">
            <div id="site">
                <a id="site-name" href="#!">Figa</a>
            </div>
        </nav>
        <div class="container">
            <main id="root">
                <div id="upload">
                    <div id="upload-root">
                        <form id="uploadForm" name="uploadForm" method="POST" enctype="multipart/form-data">
                            <div id="upload-title">
                                <h1>Upload</h1>
                            </div>
                            <div id="tag-container">
                                <input id="tags" name="tags" class="tags" type="text" placeholder="Add tags. Separate by commas." required>
                            </div>
                            <div id="upload-stage">
                                <div id="add-box" class="image-box">
                                    <input id="upload-inp" type="file" name="images" accept="image/*" multiple>
                                    <button id="add-image" for="uploadInp" type="button">+</button>
                                </div>
                            </div>
                            <div id="upload-info">
                                <p id="total_upload"></p>   
                            </div>
                            <div id="upload-controls-container">
                                <button id="upload-cancel" class="upload-control" type="button">Cancel</button>
                                <button id="upload-do" class="upload-control" type="button">Upload</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
        <script src="./js/jquery-3.4.1.min.js"></script>
        <script>
            let add_image = document.getElementById('add-image');
            let upload_inp = document.getElementById('upload-inp');
            let uploaded_files;
            let file_types = [
                'image/jpeg',
                'image/png',
                'image/svg+xml',
                'image/gif'
            ];
            add_image.addEventListener('click', e => {
                upload_inp.click();
            });

            upload_inp.addEventListener('change', e => {
                uploaded_files = upload_inp.files;
                let stage = document.getElementById('upload-stage');
                if (uploaded_files.length === 0) {
                    description.textContent = 'No files selected.';
                }
                else{
                    new Promise((resolve, reject) => {
                        for (let i = 0; i < uploaded_files.length; i++){
                            if (valiadFileType(uploaded_files[i])) {
                                let image_box = document.createElement('div');
                                image_box.className = 'image-box';
                                let img = document.createElement('img');
                                img.src = window.URL.createObjectURL(uploaded_files[i]);
                                image_box.appendChild(img);
                                stage.appendChild(image_box);
                                let del = document.createElement('span');
                                del.className = 'delete';
                                del.addEventListener('click', dropImage);
                                let del_img = document.createElement('img');
                                del_img.src = '/img/delete.svg';
                                del.appendChild(del_img);
                                image_box.appendChild(del);
                                resolve()
                            }
                            else {
                                description.textContent = `Cannot upload ${uploaded_files[i].name}, not a valid image.`
                                reject()
                            }
                        }
                    })
                    .then(() => {
                       descImageCount();
                    })
                    .catch(error => {
                        console.error(error);
                    });
                }

            });

            function descImageCount() {
                let stage = document.getElementById('upload-stage');
                let description = document.getElementById('total_upload');description.innerHTML = `<b>Total files:</b> ${stage.childElementCount - 1}`;
            }

            function dropImage(e) {
                console.log(this.parentNode.remove(this.parentNode));
                descImageCount();
            }

            function valiadFileType(file) {
                for (let i = 0; i < file_types.length; i++) {
                    if (file_types[i] === file.type) {
                        return true;
                    }
                }
                return false;
            }

            $('#uploadForm').on('click', '#upload-do', function (e) {
                event.stopPropagation();

                let formData = new FormData(document.forms.uploadForm);
                let tags = $('#tags');
                let tags_val = tags.val();
                let error = null;
                if (tags_val.length === 0) {
                    error = 'Error: Please add one or more tags.';
                }
                // else if (!/^(([a-z0-9][a-z0-9_\-]*[a-z0-9_]+)(\s*\,\s*)*)+\s*$/i.test(tags_val)) {
                //     alert('Tags should have atleast 2 characters\nBegin only with an alphabet or number\nSeparated by commas');
                //     tags.focus();
                // }
                else {
                    let split_tags = tags_val.split(',');
                    for (let i = 0; i < split_tags.length; i++) {
                        tag = split_tags[i].trim();
                        if (tag.length < 2) {
                            error = 'Error: Each tag should have at least 2 characters.'
                            break;
                        }
                        else if (!/^\w|\w$/.test(tag)) {
                            error = 'Error: Tags should begin or end only with alphabets, numbers or an underscore.' 
                            break;
                        }
                        else if (/\s/.test(tag)) {
                            error = 'Error: Tags cannot contain spaces.';
                        }
                    }
                }
                if (!uploaded_files) {
                    alert('Error: No files selected to upload.');
                }
                else if (error) {
                    tags.css('border-color', 'red');
                    alert(error);
                    tags.focus();
                }
                else {
                    $.ajax({
                        async: true,
                        url: '/upload',
                        method: 'post',
                        processData: false,
                        contentType: false,
                        data: formData,
                        success: function(data) {
                            postUpload(data);
                        },
                        error: function(data) {
                            console.error(data);
                        }
                    });
                }
            });

            function postUpload(data) {
                if (data !== 'Uploaded.') {
                    let response = JSON.parse(data);
                    console.log(response);
                    if (response['duplicates']) {
                        let message = response['duplicates'].join(', ');
                        alert(message);
                    }
                }
                else {
                    console.log(data);
                }
            }

        </script>
    </body>
</html>